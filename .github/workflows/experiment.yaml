name: Run Iter8 Experiment 
on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'The branch, tag or SHA to checkout.'
        required: true
        default: 'master'
      port:
        description: 'Port of application'
        required: true
        default: '30001'

env:
  IBM_CLOUD_API_KEY: ${{ secrets.IBM_CLOUD_API_KEY }}
  IBM_CLOUD_RESOURCE_GROUP: 585330279c4b4175890b5c59dab786fb
  IBM_CLOUD_REGION: us-south
  IKS_CLUSTER: c5u1ej8d00c0squuquog # name or id of cluster
  INGRESS_SUBDOMAIN: 'kalantar-20211029-1-f0f5a1e5d9c5f09a7767f1f253010cba-0000.us-south.containers.appdomain.cloud'
  PORT: ${{ github.event.inputs.port }}

jobs:
  experiment:
    runs-on: ubuntu-latest
    steps:

    - name: Checkout repository
      uses: actions/checkout@v2
      with:
        ref: ${{ github.event.inputs.ref }}

    - name: Install IBM Cloud CLI
      run: | 
        curl -fsSL https://clis.cloud.ibm.com/install/linux | sh
        ibmcloud --version
        ibmcloud config --check-version=false
        ibmcloud plugin install -f kubernetes-service
        ibmcloud plugin install -f container-registry

    - name: Authenticate with IBM Cloud CLI
      run: |
        ibmcloud login --apikey "${IBM_CLOUD_API_KEY}" -r "${IBM_CLOUD_REGION}" -g default
        ibmcloud cr region-set "${IBM_CLOUD_REGION}"
        ibmcloud cr login

    - name: Identify target cluster
      run: |
        ibmcloud target -g $IBM_CLOUD_RESOURCE_GROUP
        ibmcloud ks cluster config --cluster $IKS_CLUSTER
        kubectl config current-context

    - name: Install Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.17

    - name: Install Iter8 CLI
      run: GOBIN=/usr/local/bin go install github.com/iter8-tools/iter8@latest

    - run: iter8 -h

    - name: Run Iter8 Experiment (in default namespace of cluster)
      run: |
        iter8 gen exp \
          --set ref=${{ github.event.inputs.ref }} \
          --set url="http://$INGRESS_SUBDOMAIN:$PORT" \
          --set image="kalantar/myserver:${{ github.event.inputs.ref }}" \
          --set namespace="test-${{ github.event.inputs.ref }}" \
          --set user=USER \
          --set token=TOKEN
        cat experiment.yaml
        iter8 gen k8s --set loglevel=trace | kubectl apply -f -
